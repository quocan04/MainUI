<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library AI Analytics Dashboard - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .badge-hot { background: linear-gradient(135deg, #FF6B6B, #FF8E53); }
        .badge-trending { background: linear-gradient(135deg, #4ECDC4, #44A08D); }
        .badge-cold { background: linear-gradient(135deg, #A8EDEA, #FED6E3); }
    </style>
</head>
<body class="bg-gray-50">

<div class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <i data-lucide="brain" class="w-12 h-12 text-indigo-600"></i>
                        <h1 class="text-4xl font-bold text-gray-800">Library AI Analytics</h1>
                    </div>
                    <p class="text-gray-600 text-lg">Ph√¢n t√≠ch ƒëa chi·ªÅu v√† d·ª± ƒëo√°n th√¥ng minh</p>
                </div>
                <button onclick="loadAllData()" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all">
                    üîÑ Refresh All
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg mb-8 p-2">
            <div class="flex gap-2" id="tabs">
                <button onclick="showTab('overview')" class="tab-btn active px-6 py-3 rounded-lg font-medium transition-all">
                    üìä T·ªïng quan
                </button>
                <button onclick="showTab('categories')" class="tab-btn px-6 py-3 rounded-lg font-medium transition-all">
                    üìö Th·ªÉ lo·∫°i
                </button>
                <button onclick="showTab('authors')" class="tab-btn px-6 py-3 rounded-lg font-medium transition-all">
                    ‚úçÔ∏è T√°c gi·∫£
                </button>
                <button onclick="showTab('publishers')" class="tab-btn px-6 py-3 rounded-lg font-medium transition-all">
                    üè¢ Nh√† XB
                </button>
                <button onclick="showTab('forecast')" class="tab-btn px-6 py-3 rounded-lg font-medium transition-all">
                    üîÆ D·ª± ƒëo√°n
                </button>
            </div>
        </div>

        <!-- Tab Contents -->
        <div id="overview" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" id="statsCards"></div>
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-6">üìà Xu h∆∞·ªõng t·ªïng quan</h2>
                <canvas id="overviewChart" height="80"></canvas>
            </div>
        </div>

        <div id="categories" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üî• Th·ªÉ lo·∫°i Hot/Trending</h2>
                    <div id="categoriesList"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üìä Ph√¢n b·ªë l∆∞·ª£t m∆∞·ª£n</h2>
                    <canvas id="categoriesChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-6">üí° Insights & Recommendations</h2>
                <div id="categoryInsights"></div>
            </div>
        </div>

        <div id="authors" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">‚≠ê Top T√°c Gi·∫£</h2>
                    <div id="authorsList"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üìä Popularity Score</h2>
                    <canvas id="authorsChart"></canvas>
                </div>
            </div>
        </div>

        <div id="publishers" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üèÜ Top Nh√† Xu·∫•t B·∫£n</h2>
                    <div id="publishersList"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6">üìä Performance Score</h2>
                    <canvas id="publishersChart"></canvas>
                </div>
            </div>
        </div>

        <div id="forecast" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">üîÆ D·ª± ƒêo√°n Th√¥ng Minh</h2>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2">
                            <span class="text-sm">S·ªë th√°ng:</span>
                            <input type="range" id="forecastMonths" min="3" max="12" value="6"
                                   onchange="loadForecast()" class="w-32">
                            <span id="monthsLabel" class="text-sm font-bold">6</span>
                        </label>
                    </div>
                </div>
                <canvas id="forecastChart" height="80"></canvas>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-8">
                <h2 class="text-2xl font-bold mb-6">üìä Chi Ti·∫øt D·ª± ƒêo√°n</h2>
                <div class="overflow-x-auto">
                    <table class="w-full" id="forecastTable"></table>
                </div>
            </div>

            <div class="mt-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
                <h3 class="font-semibold text-gray-800 mb-4">üß† M√¥ H√¨nh AI</h3>
                <div id="modelInfo" class="text-sm text-gray-700 leading-relaxed"></div>
            </div>
        </div>

    </div>
</div>

<script>
const API_URL = 'http://localhost:5000/api/ai';
let charts = {};
let allData = {};

// ========== TAB MANAGEMENT ==========
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(tabName).classList.remove('hidden');

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-100');
    });

    event.target.classList.add('active', 'bg-indigo-600', 'text-white');
    event.target.classList.remove('text-gray-600', 'hover:bg-gray-100');
}

// ========== LOAD ALL DATA ==========
async function loadAllData() {
    try {
        const response = await fetch(`${API_URL}/insights/comprehensive`);
        const data = await response.json();

        if (data.success) {
            allData = data;
            renderOverview(data);
            renderCategories(data.categories);
            renderAuthors(data.authors);
            renderPublishers(data.publishers);
            renderForecast(data.forecast);
        } else {
            alert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
        }
    } catch (error) {
        console.error('Error loading data:', error);
        alert('L·ªói k·∫øt n·ªëi API. Vui l√≤ng ki·ªÉm tra Flask server ƒëang ch·∫°y.');
    }
}

// ========== OVERVIEW TAB ==========
function renderOverview(data) {
    const stats = `
        <div class="card bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white">
            <i data-lucide="book-open" class="w-8 h-8 mb-2"></i>
            <div class="text-3xl font-bold">${data.categories.categories?.length || 0}</div>
            <div class="text-sm opacity-90">Th·ªÉ lo·∫°i s√°ch</div>
        </div>
        <div class="card bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white">
            <i data-lucide="users" class="w-8 h-8 mb-2"></i>
            <div class="text-3xl font-bold">${data.authors.top_authors?.length || 0}</div>
            <div class="text-sm opacity-90">T√°c gi·∫£ n·ªïi b·∫≠t</div>
        </div>
        <div class="card bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white">
            <i data-lucide="building" class="w-8 h-8 mb-2"></i>
            <div class="text-3xl font-bold">${data.publishers.publishers?.length || 0}</div>
            <div class="text-sm opacity-90">Nh√† xu·∫•t b·∫£n</div>
        </div>
        <div class="card bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white">
            <i data-lucide="trending-up" class="w-8 h-8 mb-2"></i>
            <div class="text-3xl font-bold">${data.forecast.forecast?.length || 0}</div>
            <div class="text-sm opacity-90">Th√°ng d·ª± ƒëo√°n</div>
        </div>
    `;
    document.getElementById('statsCards').innerHTML = stats;
    lucide.createIcons();
}

// ========== CATEGORIES TAB ==========
function renderCategories(categoriesData) {
    if (!categoriesData.success) return;

    const categories = categoriesData.categories;

    // Render list
    const listHTML = categories.slice(0, 10).map(cat => {
        const badgeClass = cat.trend === 'hot' ? 'badge-hot' :
                          cat.trend === 'trending' ? 'badge-trending' : 'badge-cold';
        return `
            <div class="flex items-center justify-between p-4 border-b hover:bg-gray-50">
                <div>
                    <div class="font-medium text-gray-800">${cat.category}</div>
                    <div class="text-sm text-gray-500">${cat.total_borrows} l∆∞·ª£t m∆∞·ª£n</div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right">
                        <div class="text-sm font-medium">${cat.popularity_score}%</div>
                        <div class="text-xs text-gray-500">Popularity</div>
                    </div>
                    <span class="${badgeClass} text-white px-3 py-1 rounded-full text-xs font-bold">
                        ${cat.trend.toUpperCase()}
                    </span>
                </div>
            </div>
        `;
    }).join('');
    document.getElementById('categoriesList').innerHTML = listHTML;

    // Render chart
    const ctx = document.getElementById('categoriesChart').getContext('2d');
    if (charts.categories) charts.categories.destroy();

    charts.categories = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categories.map(c => c.category),
            datasets: [{
                data: categories.map(c => c.total_borrows),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // Render insights
    const insights = categoriesData.insights;
    document.getElementById('categoryInsights').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-green-50 rounded-lg">
                <div class="text-sm text-gray-600">Th·ªÉ lo·∫°i h√†ng ƒë·∫ßu</div>
                <div class="text-lg font-bold text-green-700">${insights.top_category}</div>
            </div>
            <div class="p-4 bg-blue-50 rounded-lg">
                <div class="text-sm text-gray-600">Th·ªÉ lo·∫°i HOT</div>
                <div class="text-lg font-bold text-blue-700">${insights.hot_categories_count} th·ªÉ lo·∫°i</div>
            </div>
            <div class="p-4 bg-purple-50 rounded-lg">
                <div class="text-sm text-gray-600">N√™n t·∫≠p trung</div>
                <div class="text-lg font-bold text-purple-700">${insights.recommended_categories.join(', ')}</div>
            </div>
        </div>
    `;
}

// ========== AUTHORS TAB ==========
function renderAuthors(authorsData) {
    if (!authorsData.success) return;

    const authors = authorsData.top_authors;

    // Render list
    const listHTML = authors.map((author, idx) => `
        <div class="flex items-center gap-4 p-4 border-b hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                ${idx + 1}
            </div>
            <div class="flex-1">
                <div class="font-medium text-gray-800">${author.author}</div>
                <div class="text-sm text-gray-500">${author.total_borrows} l∆∞·ª£t m∆∞·ª£n ‚Ä¢ ${author.total_books} s√°ch</div>
            </div>
            <div class="text-right">
                <div class="text-lg font-bold text-indigo-600">${author.popularity_score}</div>
                <div class="text-xs text-gray-500">Score</div>
            </div>
        </div>
    `).join('');
    document.getElementById('authorsList').innerHTML = listHTML;

    // Render chart
    const ctx = document.getElementById('authorsChart').getContext('2d');
    if (charts.authors) charts.authors.destroy();

    charts.authors = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: authors.map(a => a.author),
            datasets: [{
                label: 'Popularity Score',
                data: authors.map(a => a.popularity_score),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: 'rgb(99, 102, 241)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
        }
    });
}

// ========== PUBLISHERS TAB ==========
function renderPublishers(publishersData) {
    if (!publishersData.success) return;

    const publishers = publishersData.publishers;

    const listHTML = publishers.map((pub, idx) => `
        <div class="flex items-center gap-4 p-4 border-b hover:bg-gray-50">
            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-green-500 to-teal-600 rounded-full flex items-center justify-center text-white font-bold">
                ${idx + 1}
            </div>
            <div class="flex-1">
                <div class="font-medium text-gray-800">${pub.publisher}</div>
                <div class="text-sm text-gray-500">${pub.total_books} s√°ch ‚Ä¢ ${pub.total_borrows} l∆∞·ª£t m∆∞·ª£n</div>
            </div>
            <div class="text-right">
                <div class="text-lg font-bold text-green-600">${pub.performance_score}</div>
                <div class="text-xs text-gray-500">Performance</div>
            </div>
        </div>
    `).join('');
    document.getElementById('publishersList').innerHTML = listHTML;

    const ctx = document.getElementById('publishersChart').getContext('2d');
    if (charts.publishers) charts.publishers.destroy();

    charts.publishers = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: publishers.map(p => p.publisher),
            datasets: [{
                label: 'Performance Score',
                data: publishers.map(p => p.performance_score),
                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                borderColor: 'rgb(16, 185, 129)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
        }
    });
}

// ========== FORECAST TAB ==========
async function loadForecast() {
    const months = document.getElementById('forecastMonths').value;
    document.getElementById('monthsLabel').textContent = months;

    try {
        const response = await fetch(`${API_URL}/forecast-smart?months=${months}`);
        const data = await response.json();

        if (data.success) {
            renderForecast(data);
        }
    } catch (error) {
        console.error('Error loading forecast:', error);
    }
}

function renderForecast(forecastData) {
    if (!forecastData.success) return;

    const forecast = forecastData.forecast;

    // Render chart
    const ctx = document.getElementById('forecastChart').getContext('2d');
    if (charts.forecast) charts.forecast.destroy();

    charts.forecast = new Chart(ctx, {
        type: 'line',
        data: {
            labels: forecast.map(f => f.month_display),
            datasets: [{
                label: 'D·ª± ƒëo√°n l∆∞·ª£t m∆∞·ª£n',
                data: forecast.map(f => f.borrowing_count),
                borderColor: 'rgb(255, 152, 0)',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Render table
    const tableHTML = `
        <thead class="bg-gradient-to-r from-indigo-50 to-purple-50">
            <tr>
                <th class="px-6 py-4 text-left">Th√°ng</th>
                <th class="px-6 py-4 text-center">L∆∞·ª£t m∆∞·ª£n</th>
                <th class="px-6 py-4 text-center">Doanh thu (M)</th>
                <th class="px-6 py-4 text-center">B·∫°n ƒë·ªçc m·ªõi</th>
                <th class="px-6 py-4 text-center">Tin c·∫≠y</th>
                <th class="px-6 py-4 text-center">Factors</th>
            </tr>
        </thead>
        <tbody>
            ${forecast.map(f => `
                <tr class="border-b hover:bg-orange-50">
                    <td class="px-6 py-4 font-medium">${f.month_display}</td>
                    <td class="px-6 py-4 text-center text-blue-600 font-bold">${f.borrowing_count}</td>
                    <td class="px-6 py-4 text-center text-green-600">${(f.revenue / 1000000).toFixed(2)}M</td>
                    <td class="px-6 py-4 text-center text-orange-600">${f.new_users}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="px-3 py-1 rounded-full text-sm font-medium ${
                            f.confidence >= 90 ? 'bg-green-100 text-green-800' :
                            f.confidence >= 80 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-orange-100 text-orange-800'
                        }">
                            ${f.confidence}%
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center text-xs text-gray-600">
                        Trend: ${f.factors?.trend}%<br>
                        Season: ${f.factors?.seasonality}%<br>
                        Boost: +${f.factors?.hot_boost}%
                    </td>
                </tr>
            `).join('')}
        </tbody>
    `;
    document.getElementById('forecastTable').innerHTML = tableHTML;

    // Model info
    const modelInfo = forecastData.model_info;
    document.getElementById('modelInfo').innerHTML = `
        <p><strong>Model:</strong> ${modelInfo.type}</p>
        <p><strong>Factors:</strong> ${modelInfo.factors.join(', ')}</p>
        <p><strong>Accuracy:</strong> ${modelInfo.accuracy}</p>
        <p><strong>Hot Categories Boost:</strong> ${modelInfo.hot_categories_boost}</p>
    `;
}

// ========== INIT ==========
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
    loadAllData();
});
</script>

</body>
</html>